
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - D.Watson Pharmacy</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!--
    <style>
        :root {
            --primary-color: #2c6e8a;
            --secondary-color: #4fb3d9;
            --accent-color: #0a4d68;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --sidebar-width: 250px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #b30000;
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Top header (compact) */
        .top-header {
            background: linear-gradient(135deg, #b30000, #d32f2f);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 1rem;
        }

        .brand-compact {
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-toggle {
            color: white;
            background: transparent;
            border: none;
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }

        /* Left Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px; /* below header */
            width: var(--sidebar-width);
            height: calc(100vh - 60px);
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
            padding: 1rem 0.5rem;
            border-right: 1px solid rgba(0,0,0,0.05);
            z-index: 999;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem 0.5rem;
            font-weight: 600;
            background: transparent;
            transition: background 0.15s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.06);
            color: #fff;
        }
        
        /* Main Content */
        .main-content {
            margin-top: 60px;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            min-height: calc(100vh - 60px);
            transition: margin-left 0.2s ease;
        }
        
        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }
        
        .card-icon.primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .card-icon.success { background: linear-gradient(135deg, var(--success-color), #20c997); }
        .card-icon.warning { background: linear-gradient(135deg, var(--warning-color), #fd7e14); }
        .card-icon.info { background: linear-gradient(135deg, var(--info-color), #6f42c1); }
        
        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }
        
        .card-change {
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .card-change.positive { color: var(--success-color); }
        .card-change.negative { color: var(--danger-color); }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--dark-text);
            padding: 1rem 0.75rem;
            background-color: var(--light-bg);
        }
        
        .table td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-top: 1px solid #e9ecef;
        }
        
        /* Buttons */
        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(44, 110, 138, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #20c997);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #fd7e14);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #6f42c1);
        }
        
        /* Modals */
        .modal-content {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 1.5rem;
        }
        
        /* Forms */
        .form-control, .form-select {
            border-radius: 0.5rem;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 110, 138, 0.25);
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
                transform: translateX(0);
            }
            
        .notification.success { background: linear-gradient(135deg, var(--success-color), #20c997); }
        .notification.error { background: linear-gradient(135deg, var(--danger-color), #e74c3c); }
        .notification.warning { background: linear-gradient(135deg, var(--warning-color), #fd7e14); }
        .notification.info { background: linear-gradient(135deg, var(--info-color), #6f42c1); }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .dashboard-card {
                padding: 1.5rem;
            }
            
            .card-value {
                font-size: 1.5rem;
            }
            /* Hide the left sidebar on small screens and make top header show brand + toggle */
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

            .top-header .brand-compact {
                margin-left: 0;
            }
        }
        
        /* Hidden sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }

        /* Branch summaries styling */
        #branchSummaries .card {
            border-radius: 0.75rem;
            box-shadow: 0 6px 24px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        #branchSummaries .card-body {
            padding: 1rem 1rem;
        }

        #branchSummaries h5 {
            font-weight: 700;
            font-size: 1.05rem;
            color: var(--accent-color);
        }

        #branchSummaries .table th, #branchSummaries .table td {
            padding: 0.45rem 0.6rem;
            font-size: 0.9rem;
            vertical-align: middle;
        }

        #branchSummaries .table thead th {
            background: transparent;
            color: #495057;
            font-weight: 700;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        #branchSummaries .text-end div {
            font-size: 0.9rem;
            color: #333;
        }

        /* Category breakdown compact style inside branch summary */
        #branchSummaries .table-sm tbody tr td:first-child {
            font-weight: 600;
            color: #222;
        }

        /* Recent sales view-toggle active state */
        .btn-group .btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff !important;
            box-shadow: 0 6px 18px rgba(44,110,138,0.18);
        }

        /* Cards view layout tweaks */
        #recentSalesCards .card {
            border-radius: 0.75rem;
            box-shadow: 0 8px 28px rgba(0,0,0,0.08);
        }

        /* Responsive adjustments for branch summaries */
        @media (max-width: 992px) {
            #branchSummaries .text-end { font-size: 0.85rem; }
            #branchSummaries .table th, #branchSummaries .table td { font-size: 0.85rem; }
        }
    </style>
        -->
    <style>
:root {
  --primary-color: #0077b6;
  --secondary-color: #00b4d8;
  --accent-color: #023e8a;
  --light-bg: #f4f6f9;
  --dark-text: #1c1f23;
  --success-color: #28a745;
  --warning-color: #ffc107;
  --danger-color: #dc3545;
  --info-color: #17a2b8;
  --sidebar-width: 250px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Inter", sans-serif;
  background-color: var(--light-bg);
  color: var(--dark-text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ======= HEADER ======= */
.top-header {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  position: fixed;
  width: 100%;
  top: 0;
  z-index: 1000;
  height: 60px;
  display: flex;
  align-items: center;
  padding: 0 1rem;
}

.brand-compact {
  font-weight: 700;
  font-size: 1.1rem;
  color: white;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.sidebar-toggle {
  color: white;
  background: transparent;
  border: none;
  font-size: 1.25rem;
  margin-right: 0.75rem;
}

/* ======= SIDEBAR ======= */
.sidebar {
  position: fixed;
  left: 0;
  top: 60px;
  width: var(--sidebar-width);
  height: calc(100vh - 60px);
  background: #ffffff;
  padding: 1rem 0.5rem;
  border-right: 1px solid #e3e6ea;
  z-index: 999;
  overflow-y: auto;
}

.sidebar .nav-link {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: var(--dark-text);
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  margin: 0.25rem 0.5rem;
  font-weight: 600;
  transition: all 0.2s ease;
}

.sidebar .nav-link:hover,
.sidebar .nav-link.active {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  box-shadow: 0 3px 12px rgba(0, 119, 182, 0.15);
}

/* ======= MAIN CONTENT ======= */
.main-content {
  margin-top: 60px;
  margin-left: var(--sidebar-width);
  padding: 2rem;
  min-height: calc(100vh - 60px);
  transition: margin-left 0.2s ease;
  background-color: var(--light-bg);
}

/* ======= DASHBOARD CARDS ======= */
.dashboard-card {
  background: #ffffff;
  border-radius: 1rem;
  padding: 2rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  border: none;
  transition: all 0.3s ease;
  height: 100%;
}

.dashboard-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.card-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: white;
  margin-bottom: 1rem;
}

.card-icon.primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
.card-icon.success { background: linear-gradient(135deg, var(--success-color), #20c997); }
.card-icon.warning { background: linear-gradient(135deg, var(--warning-color), #fd7e14); }
.card-icon.info { background: linear-gradient(135deg, var(--info-color), #6f42c1); }

.card-title {
  font-size: 0.9rem;
  font-weight: 600;
  color: #6c757d;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.card-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--dark-text);
  margin-bottom: 0.5rem;
}

/* ======= TABLES ======= */
.table-container {
  background: #ffffff;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  margin-bottom: 2rem;
}

.table th {
  border-top: none;
  font-weight: 600;
  color: var(--accent-color);
  background-color: #eef4f9;
  padding: 1rem 0.75rem;
}

.table td {
  padding: 1rem 0.75rem;
  vertical-align: middle;
  border-top: 1px solid #e9ecef;
}

/* ======= BUTTONS ======= */
.btn {
  border-radius: 0.5rem;
  font-weight: 500;
  padding: 0.5rem 1.5rem;
  border: none;
  transition: all 0.3s ease;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: #fff;
}

.btn-primary:hover {
  box-shadow: 0 4px 15px rgba(0, 119, 182, 0.3);
  transform: translateY(-2px);
}

/* ======= MODALS ======= */
.modal-content {
  border-radius: 1rem;
  border: none;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.modal-header,
.modal-footer {
  border-color: #e9ecef;
}

/* ======= FORMS ======= */
.form-control,
.form-select {
  border-radius: 0.5rem;
  border: 2px solid #e9ecef;
  padding: 0.75rem 1rem;
  transition: all 0.3s ease;
}

.form-control:focus,
.form-select:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 0.2rem rgba(0, 119, 182, 0.25);
}

/* ======= NOTIFICATIONS ======= */
.notification {
  position: fixed;
  top: 100px;
  right: 20px;
  z-index: 1050;
  min-width: 300px;
  padding: 1rem 1.5rem;
  border-radius: 0.5rem;
  color: white;
  font-weight: 500;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  transform: translateX(400px);
  transition: all 0.3s ease;
}
.notification.show { transform: translateX(0); }
.notification.success { background: linear-gradient(135deg, var(--success-color), #20c997); }
.notification.error { background: linear-gradient(135deg, var(--danger-color), #e74c3c); }
.notification.warning { background: linear-gradient(135deg, var(--warning-color), #fd7e14); }
.notification.info { background: linear-gradient(135deg, var(--info-color), #6f42c1); }

/* ======= BRANCH SUMMARIES ======= */
#branchSummaries .card {
  border-radius: 0.75rem;
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
}
#branchSummaries h5 {
  color: var(--accent-color);
  font-weight: 700;
  font-size: 1rem;
}
/* === Section visibility control === */
.section {
  display: none;
}
.section.active {
  display: block;
}

/* ======= RESPONSIVE ======= */
@media (max-width: 768px) {
  .main-content { margin-left: 0; padding: 1rem; }
  .sidebar { display: none; }
  .dashboard-card { padding: 1.5rem; }
  .card-value { font-size: 1.5rem; }
}
</style>

</head>
<body>
    <!-- Top header -->
    <header class="top-header">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">â˜°</button>
        <div class="brand-compact">
            <i class="fas fa-pills"></i>
            <span>D.Watson Pharmacy</span>
        </div>
    </header>

    <!-- Left Sidebar (vertical tabs) -->
    <aside class="sidebar" id="leftSidebar">
        <nav class="nav flex-column px-2">
            <a class="nav-link active" href="#" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="#" data-section="categories">
                <i class="fas fa-tags"></i> Categories
            </a>
            <a class="nav-link" href="#" data-section="sales">
                <i class="fas fa-shopping-cart"></i> Sales Entry
            </a>
            <a class="nav-link" href="#" data-section="branches">
                <i class="fas fa-building"></i> Branches
            </a>
            <a class="nav-link" href="#" data-section="settings">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a class="nav-link" href="#" data-section="reports">
                <i class="fas fa-file-alt"></i> Reports
            </a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white mb-4">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard Overview
                    </h1>
                </div>
            </div>
            
            <!-- Dashboard Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon primary">
                            <i class="fas fa-shopping-cart"></i>
                </div>
                        <div class="card-title">Total Sales</div>
                        <div class="card-value" id="totalSales">0</div>
                        <div class="card-change positive" id="salesChange">+0%</div>
                </div>
            </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon success">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-title">Total Profit</div>
                        <div class="card-value" id="totalProfit">0</div>
                        <div class="card-change positive" id="profitChange">+0%</div>
                        </div>
                        </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon warning">
                            <i class="fas fa-building"></i>
                    </div>
                        <div class="card-title">Active Branches</div>
                        <div class="card-value" id="totalBranches">0</div>
                        <div class="card-change" id="branchesChange">0</div>
                </div>
                        </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon info">
                            <i class="fas fa-tags"></i>
                    </div>
                        <div class="card-title">Categories</div>
                        <div class="card-value" id="totalCategories">0</div>
                        <div class="card-change" id="categoriesChange">0</div>
                </div>
            </div>
        </div>
        
            <!-- Dashboard Filters & Category Breakdown -->
            <div class="mb-4">
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-3">
                        <label class="form-label">From</label>
                        <input type="date" id="dashboardFrom" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">To</label>
                        <input type="date" id="dashboardTo" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Branch</label>
                        <select id="dashboardBranchSelector" class="form-select"></select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button class="btn btn-primary" id="applyDashboardFilter">Apply</button>
                    </div>
                </div>

                <div id="categoryCards" class="mb-3"></div>
                <!-- (canonical categories display removed per user request) -->

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Sales Comparison (per day)</h5>
                        <canvas id="branchesComparisonChart" height="120"></canvas>
                    </div>
                </div>
                <!-- Branch-wise summary (total sales, cost, profit + per-category breakdown) -->
                <div id="branchSummaries" class="mb-4"></div>
            </div>

            Recent Sales Table
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Recent Sales</h5>
                        <div class="d-flex align-items-center">
                            <div class="btn-group me-2" role="group" aria-label="View toggle">
                                <button type="button" class="btn btn-outline-light btn-sm" id="viewTableBtn" onclick="setSalesView('table')">Table</button>
                                <button type="button" class="btn btn-outline-light btn-sm" id="viewCardsBtn" onclick="setSalesView('cards')">Cards</button>
                            </div>
                            <button class="btn btn-primary" onclick="showSection('sales')">
                                <i class="fas fa-plus me-1"></i>Add Sale
                            </button>
                        </div>
                </div>
                            <div class="table-responsive" id="recentSalesTableWrapper">
                            <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Branch</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Profit</th>
                                        <th>Category</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                <tbody id="recentSalesTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <div class="loading-spinner me-2"></div>
                                            Loading sales data...
                                        </td>
                                    </tr>
                                            </tbody>
                                        </table>
                            </div>
                            <div id="recentSalesCards" class="row g-3 mt-3" style="display:none;"></div>
                </div>
            </div>
            
        <!-- Categories Section -->
        <div id="categories" class="section">
            <div class="row mb-4">
                            <div class="col-12">
                    <h1 class="text-white mb-4">
                        <i class="fas fa-tags me-2"></i>
                        Categories Management
                    </h1>
                            </div>
                        </div>
                        
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Categories</h5>
                    <button class="btn btn-success" onclick="openCategoryModal()">
                        <i class="fas fa-plus me-1"></i>Add Category
                        </button>
                    </div>
                    <div class="table-responsive">
                    <table class="table">
                            <thead>
                                <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Color</th>
                                <th>Created</th>
                                <th>Actions</th>
                                </tr>
                            </thead>
                        <tbody id="categoriesTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <div class="loading-spinner me-2"></div>
                                    Loading categories...
                                </td>
                                </tr>
                            </tbody>
                        </table>
                </div>
            </div>
                    </div>
                    
        <!-- Sales Entry Section -->
        <div id="sales" class="section">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white mb-4">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Sales Entry
                    </h1>
                </div>
            </div>
            
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Sales Records</h5>
                    <button class="btn btn-success" onclick="openSaleModal()">
                        <i class="fas fa-plus me-1"></i>Add Sale
                    </button>
                </div>
                    <div class="table-responsive">
                    <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Branch</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Cost</th>
                                <th>Profit</th>
                                    <th>Category</th>
                                <th>Actions</th>
                                </tr>
                            </thead>
                        <tbody id="salesTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <div class="loading-spinner me-2"></div>
                                    Loading sales data...
                                </td>
                            </tr>
                            </tbody>
                        </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="section">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white mb-4">
                        <i class="fas fa-file-alt me-2"></i>
                        Printable Reports
                    </h1>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">From</label>
                            <input type="date" id="reportFrom" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">To</label>
                            <input type="date" id="reportTo" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Branch</label>
                            <select id="reportBranchSelector" class="form-select"></select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button class="btn btn-primary" id="generateReportBtn">Generate Preview</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportPreviewContainer" class="mb-4">
                <!-- preview will be injected here -->
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-success" id="downloadPdfBtn" style="display:none">Download PDF</button>
                <button class="btn btn-secondary" id="printReportBtn" style="display:none">Print</button>
            </div>
        </div>
        
        <!-- Branches Section -->
        <div id="branches" class="section">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white mb-4">
                        <i class="fas fa-building me-2"></i>
                        Branches Management
                    </h1>
                </div>
            </div>
            
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Branches</h5>
                    <div>
                        <button class="btn btn-info me-2" onclick="loadBranches()">
                            <i class="fas fa-refresh me-1"></i>Refresh
                        </button>
                        <button class="btn btn-success" onclick="openBranchModal()">
                            <i class="fas fa-plus me-1"></i>Add Branch
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="branchesTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <div class="loading-spinner me-2"></div>
                                    Loading branches...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white mb-4">
                        <i class="fas fa-cog me-2"></i>
                        Settings
                    </h1>
                </div>
            </div>
            
            <div class="table-container">
                <h5 class="mb-3">Application Settings</h5>
                    <form id="settingsForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                                <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" name="companyName">
                            </div>
                        <div class="col-md-6 mb-3">
                                <label for="currency" class="form-label">Currency</label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="PKR">PKR</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                </select>
                            </div>
                        <div class="col-md-6 mb-3">
                                <label for="dateFormat" class="form-label">Date Format</label>
                            <select class="form-select" id="dateFormat" name="dateFormat">
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                </select>
                            </div>
                        <div class="col-md-6 mb-3">
                                <label for="itemsPerPage" class="form-label">Items Per Page</label>
                            <input type="number" class="form-control" id="itemsPerPage" name="itemsPerPage" min="5" max="100">
                            </div>
                        <div class="col-md-6 mb-3">
                            <label for="defaultCostPercent" class="form-label">Default Cost Percentage</label>
                            <input type="number" class="form-control" id="defaultCostPercent" name="defaultCostPercent" min="0" max="100">
                        </div>
                        </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Settings
                            </button>
                        <button type="button" class="btn btn-secondary" onclick="loadSettings()">
                            <i class="fas fa-refresh me-1"></i>Reload
                            </button>
                        </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="categoryColor" class="form-label">Color</label>
                            <select class="form-select" id="categoryColor">
                                <option value="primary">Primary</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                                <option value="danger">Danger</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">
                        <span id="categorySaveText">Save Category</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sale Modal -->
    <div class="modal fade" id="saleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saleModalTitle">Add Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="saleForm">
                        <input type="hidden" id="saleId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="saleDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="saleDate" required>
                        </div>
                            <div class="col-md-6 mb-3">
                                <label for="saleBranch" class="form-label">Branch</label>
                                <select class="form-select" id="saleBranch" required>
                                    <option value="">Select Branch</option>
                                </select>
                        </div>
                            <div class="col-md-6 mb-3">
                                <label for="saleCategory" class="form-label">Category</label>
                                <select class="form-select" id="saleCategory">
                                    <option value="">Select Category</option>
                                </select>
                        </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sale Items</label>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="saleMode" id="saleModeCategory" value="category" checked>
                                    <label class="form-check-label" for="saleModeCategory">Category-wise</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="saleMode" id="saleModeTotals" value="totals">
                                    <label class="form-check-label" for="saleModeTotals">Totals only</label>
                                </div>
                            </div>

                            <div id="saleItems">
                                <div class="sale-item row mb-2">
                                    <div class="col-md-4">
                                        <select class="form-select sale-item-category" name="category">
                                            <option value="">Select Category</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" class="form-control" placeholder="Total Sale" name="total" min="0" step="0.01" required>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" class="form-control" placeholder="Cost" name="cost" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div id="saleTotalsOnly" style="display:none">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Total Sale</label>
                                        <input type="number" id="overallSaleTotal" class="form-control" min="0" step="0.01">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Total Cost</label>
                                        <input type="number" id="overallSaleCost" class="form-control" min="0" step="0.01">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Profit</label>
                                        <input type="text" id="overallSaleProfit" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSaleItem()" id="addSaleItemBtn">
                                    <i class="fas fa-plus me-1"></i>Add Category Sale
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Total Sales</h6>
                                        <h4 class="text-primary" id="saleTotal">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Total Cost</h6>
                                        <h4 class="text-warning" id="saleCost">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Profit</h6>
                                        <h4 class="text-success" id="saleProfit">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSale()">
                        <span id="saleSaveText">Save Sale</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Branch Modal -->
    <div class="modal fade" id="branchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="branchModalTitle">Add Branch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="branchForm">
                        <input type="hidden" id="branchId">
                        <div class="mb-3">
                            <label for="branchName" class="form-label">Branch Name</label>
                            <input type="text" class="form-control" id="branchName" required>
                            </div>
                        <div class="mb-3">
                            <label for="branchAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="branchAddress" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="branchPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="branchPhone">
                        </div>
                        <div class="mb-3">
                            <label for="branchEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="branchEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBranch()">
                        <span id="branchSaveText">Save Branch</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- html2pdf for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        // API Service Layer
        class APIService {
            constructor() {
                this.baseURL = '/api';
            }
            
            async request(endpoint, options = {}) {
                // Add cache-busting parameter to prevent 304 responses
                const separator = endpoint.includes('?') ? '&' : '?';
                const url = `${this.baseURL}${endpoint}${separator}_t=${Date.now()}`;
                
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        ...options.headers
                    },
                    ...options
                };
                
                try {
                    console.log(`ðŸŒ Making API request to: ${url}`);
                    const response = await fetch(url, config);
                    
                    console.log(`ðŸ“¡ API Response: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`âœ… API Data received:`, data);
                    return data;
                } catch (error) {
                    console.error(`âŒ API request failed for ${endpoint}:`, error);
                    throw error;
                }
            }
            
            // Health
            async getHealth() {
                return this.request('/health');
            }
            
            // Settings
            async getSettings() {
                return this.request('/settings');
            }
            
            async updateSettings(settings) {
                return this.request('/settings', {
                    method: 'PUT',
                    body: JSON.stringify(settings)
                });
            }
            
            // Branches
            async getBranches() {
                return this.request('/branches');
            }
            
            async createBranch(branch) {
                return this.request('/branches', {
                    method: 'POST',
                    body: JSON.stringify(branch)
                });
            }
            
            async updateBranch(id, branch) {
                return this.request(`/branches/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(branch)
                });
            }
            
            async deleteBranch(id) {
                return this.request(`/branches/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Categories
            async getCategories() {
                return this.request('/categories');
            }
            
            async createCategory(category) {
                return this.request('/categories', {
                    method: 'POST',
                    body: JSON.stringify(category)
                });
            }
            
            async updateCategory(id, category) {
                return this.request(`/categories/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(category)
                });
            }
            
            async deleteCategory(id) {
                return this.request(`/categories/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Sales
            async getSales(filters = {}) {
                // Clean filters: remove undefined, null, empty or string 'undefined' values
                const cleaned = {};
                Object.keys(filters || {}).forEach(key => {
                    const val = filters[key];
                    if (val === undefined || val === null) return;
                    if (typeof val === 'string' && (val.trim() === '' || val === 'undefined')) return;
                    cleaned[key] = val;
                });

                const qp = new URLSearchParams(cleaned);
                const qs = qp.toString();
                return this.request(`/sales${qs ? '?' + qs : ''}`);
            }
            
            async createSale(sale) {
                return this.request('/sales', {
                    method: 'POST',
                    body: JSON.stringify(sale)
                });
            }
            
            async updateSale(id, sale) {
                return this.request(`/sales/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(sale)
                });
            }

            async deleteSale(id) {
                return this.request(`/sales/${id}`, {
                    method: 'DELETE'
                });
            }
            
            // Admin-protected actions (frontend wrappers for server /api/admin/* endpoints)
            async adminDelete(resource, id, password) {
                return this.request('/admin/delete', {
                    method: 'POST',
                    body: JSON.stringify({ resource, id, password })
                });
            }

            async adminUpdate(resource, id, payload, password) {
                return this.request('/admin/update', {
                    method: 'POST',
                    body: JSON.stringify({ resource, id, payload, password })
                });
            }
        }
        
        // Global API instance
        const api = new APIService();
        
        // Global data storage (NO localStorage)
        let appData = {
            sales: [],
            branches: [],
            categories: [],
            // view preference for recent sales: 'table' or 'cards'
            salesView: 'table',
            settings: {
                companyName: 'D.Watson Group of Pharmacy',
                currency: 'PKR',
                dateFormat: 'DD/MM/YYYY',
                itemsPerPage: 10,
                defaultCostPercent: 70
            }
        };
        
        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function formatCurrency(amount, currency = 'PKR') {
            return new Intl.NumberFormat('en-PK', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-GB');
        }
        
        function showSection(sectionName, event = null) {
            console.log(`ðŸ”„ Switching to section: ${sectionName}`);

            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) targetSection.classList.add('active');

            // Update navigation (sidebar or any nav-link)
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // Try to find a nav-link with matching data-section or onclick
                const fallback = document.querySelector(`.nav-link[data-section="${sectionName}"]`);
                if (fallback) fallback.classList.add('active');
            }

            // Load section data
            loadSectionData(sectionName);
        }
        
        async function loadSectionData(sectionName) {
            console.log(`ðŸ”„ Loading data for section: ${sectionName}`);
            try {
                switch (sectionName) {
                    case 'dashboard':
                        console.log('ðŸ“Š Loading dashboard data...');
                        await loadDashboardData();
                        break;
                    case 'categories':
                        console.log('ðŸ·ï¸ Loading categories data...');
                        await loadCategories();
                        break;
                    case 'sales':
                        console.log('ðŸ’° Loading sales data...');
                        await loadSales();
                        break;
                    case 'branches':
                        console.log('ðŸ¢ Loading branches data...');
                        await loadBranches();
                        break;
                    case 'settings':
                        console.log('âš™ï¸ Loading settings data...');
                        await loadSettings();
                        break;
                    default:
                        console.log(`âš ï¸ Unknown section: ${sectionName}`);
                }
            } catch (error) {
                console.error(`âŒ Error loading ${sectionName} data:`, error);
                showNotification(`Failed to load ${sectionName} data`, 'error');
            }
        }
        
        // Dashboard functions
        async function loadDashboardData() {
            try {
                // Load all data in parallel
                const [sales, branches, categories] = await Promise.all([
                    api.getSales(),
                    api.getBranches(),
                    api.getCategories()
                ]);
                
                appData.sales = sales;
                appData.branches = branches;
                appData.categories = categories;
                
                updateDashboardCards();
                updateRecentSalesTable();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }
        
        function updateDashboardCards() {
            const sales = appData.sales;
            const branches = appData.branches;
            const categories = appData.categories;
            
            // Calculate totals
            const totalSales = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalProfit = sales.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            
            // Update cards
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('totalBranches').textContent = branches.length;
            document.getElementById('totalCategories').textContent = categories.length;
        }

        // --- Dashboard Filters / Category Cards / Branch Comparison Chart ---
        // Populate branch selector used by dashboard filters
        async function populateDashboardBranchSelector() {
            try {
                const branches = await api.getBranches();
                appData.branches = branches;
                const sel = document.getElementById('dashboardBranchSelector');
                if (!sel) return;
                sel.innerHTML = '<option value="">All Branches</option>' + branches.map(b => `<option value="${b._id}">${b.name}</option>`).join('');
            } catch (e) {
                console.error('Error populating dashboard branches:', e);
            }
        }

        // Set default date range (last 30 days)
        function setDefaultDashboardDates() {
            const to = new Date();
            const from = new Date();
            from.setDate(to.getDate() - 30);
            const pad = d => d.toISOString().slice(0,10);
            const fEl = document.getElementById('dashboardFrom');
            const tEl = document.getElementById('dashboardTo');
            if (fEl && tEl) {
                fEl.value = pad(from);
                tEl.value = pad(to);
            }
        }

        // Render category cards using sales filtered by selected range/branch
        async function renderCategoryBreakdown() {
            try {
                const from = document.getElementById('dashboardFrom').value;
                const to = document.getElementById('dashboardTo').value;
                const branchId = document.getElementById('dashboardBranchSelector').value || undefined;

                // Fetch latest categories and branches
                const [categories, branches] = await Promise.all([api.getCategories(), api.getBranches()]);
                appData.categories = categories;
                appData.branches = branches;

                // Fetch sales for range/branch
                const sales = await api.getSales({ from: from || undefined, to: to || undefined, branchId: branchId || undefined });

                // Group totals by category using canonical categories from categories tab
                const normalizeKey = v => String(v || '').toLowerCase().replace(/[^a-z0-9]/g,'');
                const totalsByCategory = {};
                const displayName = {};

                // build normalized map of known categories (source of truth)
                const canonicalMap = {};
                categories.forEach(c => {
                    const key = normalizeKey(c.name);
                    canonicalMap[key] = c.name.trim();
                    // initialize totals for canonical categories
                    totalsByCategory[key] = 0;
                    displayName[key] = c.name.trim();
                });

                // helper: find the canonical normalized key for a raw category (or null)
                function findCanonicalKey(raw) {
                    const n = normalizeKey(raw || '');
                    if (!n) return null;
                    if (canonicalMap[n]) return n;
                    // substring / token heuristics
                    for (const k of Object.keys(canonicalMap)) {
                        if (!k) continue;
                        if (k.includes(n) || n.includes(k)) return k;
                    }
                    const tokens = n.split(/\s+/).filter(Boolean);
                    for (const k of Object.keys(canonicalMap)) {
                        const kt = k.split(/\s+/);
                        if (tokens.some(t => kt.includes(t))) return k;
                    }
                    // no canonical match
                    return null;
                }

                // aggregate into canonical keys only; if no canonical match, try to normalize raw key and add that as a custom key
                sales.forEach(s => {
                    const raw = s.category || '';
                    const key = findCanonicalKey(raw);
                    if (key) {
                        totalsByCategory[key] = (totalsByCategory[key] || 0) + Number(s.total || 0);
                    } else {
                        // create a normalized custom key from raw text so variants still collapse among themselves
                        const nk = normalizeKey(raw);
                        if (!totalsByCategory[nk]) {
                            totalsByCategory[nk] = 0;
                            displayName[nk] = String(raw).trim() || 'Uncategorized';
                        }
                        totalsByCategory[nk] += Number(s.total || 0);
                    }
                });

                const container = document.getElementById('categoryCards');
                if (!container) return;
                // Create cards for each category that has a value (or for requested ones)
                const cards = [];
                // Show requested categories first in specified order (use canonical names if available)
                const requested = ['Medicie (Nutra)', 'Medicine Aims', 'Cosmetics'];
                const reqKeys = requested.map(r => findCanonicalKey(r)).filter(Boolean);
                requested.forEach(name => {
                    const rk = findCanonicalKey(name);
                    if (!rk) return;
                    const amt = totalsByCategory[rk] || 0;
                    const title = displayName[rk] || canonicalMap[rk] || name;
                    cards.push(`
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${title}</h5>
                                    <p class="card-text">Total Sales: <strong>${formatCurrency(amt)}</strong></p>
                                </div>
                            </div>
                        </div>
                    `);
                    // remove from totals so we don't duplicate below
                    delete totalsByCategory[rk];
                    delete displayName[rk];
                });

                // Add remaining categories (canonical or normalized raw keys), limit to show top 6 total cards
                const remainingKeys = Object.keys(totalsByCategory);
                // sort remaining by amount desc
                remainingKeys.sort((a,b) => (totalsByCategory[b]||0) - (totalsByCategory[a]||0));
                const spaceLeft = Math.max(0, 6 - cards.length);
                const showKeys = remainingKeys.slice(0, spaceLeft);
                showKeys.forEach(key => {
                    const amt = totalsByCategory[key] || 0;
                    const title = displayName[key] || canonicalMap[key] || key;
                    cards.push(`
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${title}</h5>
                                    <p class="card-text">Total Sales: <strong>${formatCurrency(amt)}</strong></p>
                                </div>
                            </div>
                        </div>
                    `);
                });

                container.innerHTML = `<div class="row">${cards.join('')}</div>`;
                console.log('Canonical categories:', categories.map(c=>c.name));

                // Render branch comparison chart
                await renderBranchComparisonChart(sales, branches, from, to);
                // Render branch-wise summaries at the bottom of dashboard
                renderBranchSummaries(sales, branches, from, to);

            } catch (e) {
                console.error('Error rendering category breakdown:', e);
                showNotification('Failed to render category breakdown', 'error');
            }
        }

        // Branch comparison chart handler
        let branchesChartInstance = null;
        async function renderBranchComparisonChart(sales, branches, from, to) {
            try {
                const canvas = document.getElementById('branchesComparisonChart');
                if (!canvas) return;

                // Build labels (dates) between from and to
                const start = from ? new Date(from) : (() => { const d=new Date(); d.setDate(d.getDate()-30); return d; })();
                const end = to ? new Date(to) : new Date();
                // Normalize to dates array (daily)
                const labels = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    labels.push(new Date(d).toISOString().slice(0,10));
                }

                // For each branch, compute totals per day
                const datasets = branches.map((b, idx) => {
                    const data = labels.map(label => {
                        const dayTotal = sales
                            .filter(s => (s.branchId && (s.branchId._id === b._id || s.branchId === b._id) ) || false)
                            .filter(s => (s.date ? new Date(s.date).toISOString().slice(0,10) : '').toString() === label)
                            .reduce((sum, s) => sum + Number(s.total || 0), 0);
                        return dayTotal;
                    });
                    const color = `hsl(${(idx*60)%360} 70% 50%)`;
                    return {
                        label: b.name,
                        data,
                        borderColor: color,
                        backgroundColor: color,
                        tension: 0.2,
                        fill: false
                    };
                });

                const cfg = {
                    type: 'line',
                    data: {
                        labels,
                        datasets
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { ticks: { callback: v => formatCurrency(v) } } }
                    }
                };

                if (branchesChartInstance) {
                    branchesChartInstance.destroy();
                }
                branchesChartInstance = new Chart(canvas, cfg);

            } catch (e) {
                console.error('Error rendering branches chart:', e);
            }
        }
//================================================== branches summaries ================================
            // âœ… Fixed & cleaned version
function renderBranchSummaries(sales = [], branches = [], from, to) {
  try {
    const container = document.getElementById('branchSummaries');
    if (!container) return;

    // âœ… Make sure categories exist safely
    const categories = Array.isArray(appData?.categories) ? appData.categories : [];

    // Build canonical category map
    const normalizeKey = v => String(v || '').toLowerCase().replace(/[^a-z0-9]/g, '');
    const canonicalMap = {};
    categories.forEach(c => {
      if (c?.name) canonicalMap[normalizeKey(c.name)] = c.name.trim();
    });

    // Prepare branch data
    const byBranch = {};
    for (const b of branches) {
      byBranch[b._id] = {
        branch: b,
        total: 0,
        costTotal: 0,
        profit: 0,
        categories: {}
      };
    }

    // Aggregate sales per branch
    for (const s of sales) {
      const bid = s.branchId && (s.branchId._id || s.branchId)
        ? (s.branchId._id || s.branchId)
        : 'unknown';

      if (!byBranch[bid]) {
        byBranch[bid] = {
          branch: { _id: bid, name: s.branchId?.name || 'Unknown' },
          total: 0,
          costTotal: 0,
          profit: 0,
          categories: {}
        };
      }

      const br = byBranch[bid];
      const total = Number(s.total || 0);
      const cost = Number(s.costTotal || s.cost || 0);
      const profit = Number(s.profit || (total - cost)) || 0;

      br.total += total;
      br.costTotal += cost;
      br.profit += profit;

      const rawCat = (s.category || 'Uncategorized').trim();

      // find canonical name
      const findCanon = (raw) => {
        const n = normalizeKey(raw);
        if (canonicalMap[n]) return canonicalMap[n];
        for (const k of Object.keys(canonicalMap)) {
          if (k.includes(n) || n.includes(k)) return canonicalMap[k];
        }
        return raw || 'Uncategorized';
      };

      const catName = findCanon(rawCat);
      if (!br.categories[catName]) br.categories[catName] = { total: 0, cost: 0, profit: 0 };
      br.categories[catName].total += total;
      br.categories[catName].cost += cost;
      br.categories[catName].profit += profit;
    }

    // Convert to array & sort descending by total
    const branchList = Object.values(byBranch).sort((a, b) => b.total - a.total);

    // Build HTML
    const htmlParts = branchList.map(b => {
      const margin = b.total > 0 ? ((b.profit / b.total) * 100).toFixed(1) : '0.0';
      const canonicalKeys = Object.keys(canonicalMap);
      const catTotals = {};

      // Init totals for canonical keys
      canonicalKeys.forEach(k => {
        catTotals[canonicalMap[k]] = { total: 0, cost: 0, profit: 0 };
      });

      // Distribute categories
      Object.keys(b.categories).forEach(rawK => {
        const amount = b.categories[rawK].total || 0;
        const cost = b.categories[rawK].cost || 0;
        const profit = b.categories[rawK].profit || 0;
        const nk = normalizeKey(rawK);
        let matched = null;

        if (canonicalMap[nk]) matched = canonicalMap[nk];
        else {
          for (const k of canonicalKeys) {
            if (k.includes(nk) || nk.includes(k)) { matched = canonicalMap[k]; break; }
          }
        }

        const display = matched || String(rawK).trim() || 'Uncategorized';
        if (!catTotals[display]) catTotals[display] = { total: 0, cost: 0, profit: 0 };
        catTotals[display].total += amount;
        catTotals[display].cost += cost;
        catTotals[display].profit += profit;
      });

      // Order categories
      const requestedNames = ['Medicine (Nutra)', 'Medicine Aims', 'Cosmetics'].map(r => {
        const k = normalizeKey(r);
        return canonicalMap[k] || r;
      });
      const ordered = [];
      requestedNames.forEach(rn => { if (catTotals[rn]) ordered.push(rn); });
      Object.keys(catTotals).forEach(name => {
        if (!ordered.includes(name) && catTotals[name].total > 0) ordered.push(name);
      });

      const catRows = ordered.map(k => {
        const c = catTotals[k];
        const pm = c.total ? ((c.profit / c.total) * 100).toFixed(1) : '0.0';
        return `
          <tr>
            <td>${k}</td>
            <td>${formatCurrency(c.total || 0)}</td>
            <td>${formatCurrency(c.cost || 0)}</td>
            <td>${formatCurrency(c.profit || 0)}</td>
            <td>${pm}%</td>
          </tr>
        `;
      }).join('');

      return `
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">${b.branch.name || 'Unknown Branch'}</h5>
              <div class="text-end">
                <div>Total Sales: <strong>${formatCurrency(b.total || 0)}</strong></div>
                <div>Total Cost: <strong>${formatCurrency(b.costTotal || 0)}</strong></div>
                <div>Total Profit: <strong>${formatCurrency(b.profit || 0)}</strong></div>
                <div>Profit Margin: <strong>${margin}%</strong></div>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Category Breakdown</th>
                    <th>Total Sales</th>
                    <th>Total Cost</th>
                    <th>Profit</th>
                    <th>Profit Margin</th>
                  </tr>
                </thead>
                <tbody>${catRows}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    });

    container.innerHTML = htmlParts.join('') || '<div class="text-muted">No branch sales data for the selected range.</div>';
  } catch (e) {
    console.error('Error rendering branch summaries:', e);
  }
}




        //=============================================================================
        // Render branch summaries sorted by total sales (desc)
        // function renderBranchSummaries(sales, branches, from, to) {
        //     try {
        //         const container = document.getElementById('branchSummaries');
        //         if (!container) return;
//         function renderBranchSummaries(sales = [], branches = [], from, to) {
//   try {
//     const container = document.getElementById('branchSummaries');       
//     if (!container) return;

//                 // Aggregate sales per branch and per category using canonical category mapping
//                 const normalizeKey = v => String(v || '').toLowerCase().replace(/[^a-z0-9]/g,'');
//                 const canonicalMap = {};
//                 categories.forEach(c => {
//                     canonicalMap[normalizeKey(c.name)] = c.name.trim();
//                 });
//                 const categories = Array.isArray(appData.categories) ? appData.categories : [];

//     // (keep the rest of your existing logic here)
//     // Aggregate sales per branch and per category using canonical category mapping
//     const normalizeKey = v => String(v || '').toLowerCase().replace(/[^a-z0-9]/g,'');
//     const canonicalMap = {};
//     categories.forEach(c => {
//         canonicalMap[normalizeKey(c.name)] = c.name.trim();
//     });

//                 const byBranch = {};
//                 for (const b of branches) {
//                     byBranch[b._1d || b._id] = { branch: b, total: 0, costTotal: 0, profit: 0, categories: {} };
//                 }

//                 for (const s of sales) {
//                     const bid = s.branchId && (s.branchId._id || s.branchId) ? (s.branchId._id || s.branchId) : 'unknown';
//                     if (!byBranch[bid]) {
//                         // create a placeholder branch entry if missing
//                         byBranch[bid] = { branch: { _id: bid, name: s.branchId?.name || 'Unknown' }, total: 0, costTotal: 0, profit: 0, categories: {} };
//                     }
//                     const br = byBranch[bid];
//                     const total = Number(s.total || 0);
//                     const cost = Number(s.costTotal || s.costTotal || 0) || Number(s.cost || 0) || 0;
//                     const profit = Number(s.profit || (total - cost)) || 0;
//                     br.total += total;
//                     br.costTotal += cost;
//                     br.profit += profit;

//                     const rawCat = (s.category || 'Uncategorized').trim();
//                     // find canonical name
//                     const findCanon = (raw) => {
//                         const n = normalizeKey(raw);
//                         if (canonicalMap[n]) return canonicalMap[n];
//                         for (const k of Object.keys(canonicalMap)) {
//                             if (k.includes(n) || n.includes(k)) return canonicalMap[k];
//                         }
//                         return raw || 'Uncategorized';
//                     };

//                     const catName = findCanon(rawCat);
//                     if (!br.categories[catName]) br.categories[catName] = { total: 0, cost: 0, profit: 0 };
//                     br.categories[catName].total += total;
//                     br.categories[catName].cost += cost;
//                     br.categories[catName].profit += profit;
//                 }

//                 // Convert to array and sort descending by total
//                 const branchList = Object.values(byBranch).sort((a,b) => b.total - a.total);

//                 // Build HTML
//                 const htmlParts = branchList.map(b => {
//                     const margin = b.total > 0 ? ((b.profit / b.total) * 100).toFixed(1) : '0.0';
//                     // Build category breakdown rows using canonical category ordering when possible.
//                     const canonicalKeys = Object.keys(canonicalMap);
//                     const catTotals = {};
//                     // init totals for canonical keys
//                     canonicalKeys.forEach(k => { catTotals[canonicalMap[k]] = { total:0, cost:0, profit:0 }; });

//                     // distribute b.categories values into canonical buckets or normalized raw buckets
//                     Object.keys(b.categories).forEach(rawK => {
//                         const amount = b.categories[rawK].total || 0;
//                         const cost = b.categories[rawK].cost || 0;
//                         const profit = b.categories[rawK].profit || 0;
//                         // find canonical key
//                         const nk = normalizeKey(rawK);
//                         let matched = null;
//                         if (canonicalMap[nk]) matched = canonicalMap[nk];
//                         else {
//                             for (const k of canonicalKeys) {
//                                 if (k.includes(nk) || nk.includes(k)) { matched = canonicalMap[k]; break; }
//                             }
//                         }
//                         if (matched) {
//                             catTotals[matched].total += amount;
//                             catTotals[matched].cost += cost;
//                             catTotals[matched].profit += profit;
//                         } else {
//                             // use normalized raw key as display name so variants collapse among themselves
//                             const display = String(rawK).trim() || 'Uncategorized';
//                             if (!catTotals[display]) catTotals[display] = { total:0, cost:0, profit:0 };
//                             catTotals[display].total += amount;
//                             catTotals[display].cost += cost;
//                             catTotals[display].profit += profit;
//                         }
//                     });

//                     // order categories: show canonical in a sensible order (requested first), then other non-canonical names
//                     const requestedNames = ['Medicie (Nutra)', 'Medicine Aims', 'Cosmetics'].map(r => {
//                         const k = normalizeKey(r);
//                         return canonicalMap[k] || r;
//                     });
//                     const ordered = [];
//                     requestedNames.forEach(rn => { if (catTotals[rn]) ordered.push(rn); });
//                     // add remaining names with data
//                     Object.keys(catTotals).forEach(name => {
//                         if (!ordered.includes(name) && catTotals[name].total > 0) ordered.push(name);
//                     });

//                     const catRows = ordered.map(k => {
//                         const c = catTotals[k];
//                         const pm = c && c.total ? ((c.profit / c.total) * 100).toFixed(1) : '0.0';
//                         return `
//                             <tr>
//                                 <td>${k}</td>
//                                 <td>${formatCurrency(c.total || 0)}</td>
//                                 <td>${formatCurrency(c.cost || 0)}</td>
//                                 <td>${formatCurrency(c.profit || 0)}</td>
//                                 <td>${pm}%</td>
//                             </tr>
//                         `;
//                     }).join('');

//                     return `
//                         <div class="card mb-3">
//                             <div class="card-body">
//                                 <div class="d-flex justify-content-between align-items-center mb-2">
//                                     <h5 class="mb-0">${b.branch.name || 'Unknown Branch'}</h5>
//                                     <div class="text-end">
//                                         <div>Total Sales: <strong>${formatCurrency(b.total || 0)}</strong></div>
//                                         <div>Total Cost: <strong>${formatCurrency(b.costTotal || 0)}</strong></div>
//                                         <div>Total Profit: <strong>${formatCurrency(b.profit || 0)}</strong></div>
//                                         <div>Profit Margin: <strong>${margin}%</strong></div>
//                                     </div>
//                                 </div>
//                                 <div class="table-responsive">
//                                     <table class="table table-sm mb-0">
//                                         <thead>
//                                             <tr><th>Category Breakdown</th><th>Total Sales</th><th>Total Cost</th><th>Profit</th><th>Profit Margin</th></tr>
//                                         </thead>
//                                         <tbody>
//                                             ${catRows}
//                                         </tbody>
//                                     </table>
//                                 </div>
//                             </div>
//                         </div>
//                     `;
//                 });

//                 container.innerHTML = htmlParts.join('') || '<div class="text-muted">No branch sales data for the selected range.</div>';
//             } catch (e) {
//                 console.error('Error rendering branch summaries:', e);
//             }
//         }


//===================================================================
        // --- Reports generation ---
        async function populateReportBranchSelector() {
            try {
                const branches = await api.getBranches();
                const sel = document.getElementById('reportBranchSelector');
                if (!sel) return;
                sel.innerHTML = '<option value="">All Branches</option>' + branches.map(b => `<option value="${b._id}">${b.name}</option>`).join('');
            } catch (e) {
                console.error('Error populating report branches:', e);
            }
        }

        function buildReportHtml(sales, from, to, branchName) {
            const total = sales.reduce((s, x) => s + Number(x.total || 0), 0);
            const byCategory = {};
            sales.forEach(s => {
                const cat = s.category || 'Uncategorized';
                byCategory[cat] = (byCategory[cat] || 0) + Number(s.total || 0);
            });

            const rows = Object.keys(byCategory).map(cat => `<tr><td>${cat}</td><td>${formatCurrency(byCategory[cat])}</td></tr>`).join('');

            return `
                <div id="reportContent" style="padding:20px;background:#fff;color:#000">
                    <h2>Sales Report</h2>
                    <p><strong>Branch:</strong> ${branchName || 'All Branches'}</p>
                    <p><strong>From:</strong> ${from} <strong>To:</strong> ${to}</p>
                    <h4>Total Sales: ${formatCurrency(total)}</h4>
                    <h5>By Category</h5>
                    <table style="width:100%;border-collapse:collapse" border="1">
                        <thead><tr><th>Category</th><th>Total</th></tr></thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        document.getElementById('generateReportBtn')?.addEventListener('click', async function() {
            const from = document.getElementById('reportFrom').value;
            const to = document.getElementById('reportTo').value;
            const branchId = document.getElementById('reportBranchSelector').value || undefined;

            try {
                const sales = await api.getSales({ from: from || undefined, to: to || undefined, branchId: branchId || undefined });
                const branchName = (document.getElementById('reportBranchSelector').selectedOptions[0] || {}).text || 'All Branches';
                const html = buildReportHtml(sales, from, to, branchName);
                const container = document.getElementById('reportPreviewContainer');
                container.innerHTML = html;
                document.getElementById('downloadPdfBtn').style.display = 'inline-block';
                document.getElementById('printReportBtn').style.display = 'inline-block';

                // Bind download
                document.getElementById('downloadPdfBtn').onclick = function() {
                    const el = document.getElementById('reportContent');
                    html2pdf().set({ margin: 10, filename: `sales-report-${from}-${to}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 } }).from(el).save();
                };

                // Bind print
                document.getElementById('printReportBtn').onclick = function() {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(container.innerHTML);
                    printWindow.document.close();
                    printWindow.print();
                };

            } catch (e) {
                console.error('Error generating report:', e);
                showNotification('Failed to generate report', 'error');
            }
        });
        
        function updateRecentSalesTable() {
            const recentSales = appData.sales.slice(0, 10);
            // reflect user's view preference and update UI state
            const tableWrapper = document.getElementById('recentSalesTableWrapper');
            const cardsContainer = document.getElementById('recentSalesCards');
            // update toggle active classes if buttons exist
            const viewTableBtn = document.getElementById('viewTableBtn');
            const viewCardsBtn = document.getElementById('viewCardsBtn');
            if (viewTableBtn) viewTableBtn.classList.toggle('active', appData.salesView === 'table');
            if (viewCardsBtn) viewCardsBtn.classList.toggle('active', appData.salesView === 'cards');

            if (appData.salesView === 'cards') {
                // show cards, hide table
                if (tableWrapper) tableWrapper.style.display = 'none';
                if (cardsContainer) cardsContainer.style.display = 'flex';
                renderSalesCards(recentSales);
                return;
            }

            // ensure table is visible and cards hidden
            if (tableWrapper) tableWrapper.style.display = '';
            if (cardsContainer) cardsContainer.style.display = 'none';

            const tbody = document.getElementById('recentSalesTable');
            if (recentSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No sales data available</td></tr>';
                return;
            }

            tbody.innerHTML = recentSales.map(sale => `
                <tr>
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.branchId?.name || 'Unknown Branch'}</td>
                    <td>${sale.items?.length || 0} items</td>
                    <td>${formatCurrency(sale.total || 0)}</td>
                    <td>${formatCurrency(sale.profit || 0)}</td>
                    <td>${sale.category || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteSale('${sale._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                            </td>
                        </tr>
            `).join('');
        }

        function renderSalesCards(sales) {
            const container = document.getElementById('recentSalesCards');
            const tableWrapper = document.getElementById('recentSalesTableWrapper');
            tableWrapper.style.display = 'none';
            container.style.display = 'flex';
            container.innerHTML = '';

            if (!sales || sales.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">No sales data available</div>';
                return;
            }

            for (const sale of sales) {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-1">${sale.category || 'Sale'}</h6>
                            <p class="card-text mb-1"><strong>${formatCurrency(sale.total || 0)}</strong> â€” ${sale.items?.length || 0} items</p>
                            <p class="card-text text-muted small">${formatDate(sale.date)} â€¢ ${sale.branchId?.name || 'Unknown'}</p>
                        </div>
                        <div class="card-footer bg-transparent border-0 d-flex justify-content-end">
                            <button class="btn btn-sm btn-danger" onclick="deleteSale('${sale._id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            }
        }

        function setSalesView(view) {
            appData.salesView = view === 'cards' ? 'cards' : 'table';
            // toggle active classes
            document.getElementById('viewTableBtn').classList.toggle('active', appData.salesView === 'table');
            document.getElementById('viewCardsBtn').classList.toggle('active', appData.salesView === 'cards');
            // re-render recent sales
            updateRecentSalesTable();
        }
        
        // Categories functions
        async function loadCategories() {
            try {
                const categories = await api.getCategories();
                appData.categories = categories;
                updateCategoriesTable();
            } catch (error) {
                console.error('Error loading categories:', error);
                showNotification('Failed to load categories', 'error');
            }
        }
        
        function updateCategoriesTable() {
            const tbody = document.getElementById('categoriesTable');
            
            if (appData.categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No categories available</td></tr>';
                return;
            }
            
            tbody.innerHTML = appData.categories.map(category => `
                <tr>
                    <td>${category.name}</td>
                    <td>${category.description || 'N/A'}</td>
                    <td><span class="badge bg-${category.color || 'primary'}">${category.color || 'primary'}</span></td>
                    <td>${formatDate(category.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editCategory('${category._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openCategoryModal(categoryId = null) {
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            const title = document.getElementById('categoryModalTitle');
            const form = document.getElementById('categoryForm');
            
            form.reset();
            document.getElementById('categoryId').value = '';
            
            if (categoryId) {
                const category = appData.categories.find(c => c._id === categoryId);
                if (category) {
                    title.textContent = 'Edit Category';
                    document.getElementById('categoryId').value = category._id;
                    document.getElementById('categoryName').value = category.name;
                    document.getElementById('categoryDescription').value = category.description || '';
                    document.getElementById('categoryColor').value = category.color || 'primary';
                }
            } else {
                title.textContent = 'Add Category';
            }
            
            modal.show();
        }
        
        async function saveCategory() {
            const form = document.getElementById('categoryForm');
            const formData = new FormData(form);
            const categoryId = document.getElementById('categoryId').value;
            
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                color: document.getElementById('categoryColor').value
            };
            
            if (!categoryData.name.trim()) {
                showNotification('Category name is required', 'error');
                return;
            }
            
            const saveBtn = document.getElementById('categorySaveText');
            const originalText = saveBtn.textContent;
            saveBtn.innerHTML = '<div class="loading-spinner me-2"></div>Saving...';
            
            try {
                let savedCategory;
                if (categoryId) {
                    savedCategory = await api.updateCategory(categoryId, categoryData);
                    const index = appData.categories.findIndex(c => c._id === categoryId);
                    if (index !== -1) {
                        appData.categories[index] = savedCategory;
                    }
                } else {
                    savedCategory = await api.createCategory(categoryData);
                    appData.categories.push(savedCategory);
                }
                
                updateCategoriesTable();
                bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                showNotification('Category saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving category:', error);
                showNotification('Failed to save category', 'error');
            } finally {
                saveBtn.textContent = originalText;
            }
        }
        
        async function editCategory(categoryId) {
            openCategoryModal(categoryId);
        }
        
        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category?')) {
                return;
            }
            
            try {
                await api.deleteCategory(categoryId);
                appData.categories = appData.categories.filter(c => c._id !== categoryId);
                updateCategoriesTable();
                showNotification('Category deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                showNotification('Failed to delete category', 'error');
            }
        }
        
        // Sales functions
        async function loadSales() {
            try {
                const sales = await api.getSales();
                appData.sales = sales;
                updateSalesTable();
            } catch (error) {
                console.error('Error loading sales:', error);
                showNotification('Failed to load sales', 'error');
            }
        }
        
        function updateSalesTable() {
            const tbody = document.getElementById('salesTable');
            
            if (appData.sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No sales data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = appData.sales.map(sale => `
                <tr>
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.branchId?.name || 'Unknown Branch'}</td>
                    <td>${sale.items?.length || 0} items</td>
                    <td>${formatCurrency(sale.total || 0)}</td>
                    <td>${formatCurrency(sale.costTotal || 0)}</td>
                    <td>${formatCurrency(sale.profit || 0)}</td>
                    <td>${sale.category || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteSale('${sale._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
    async function openSaleModal(saleId = null) {
            const modal = new bootstrap.Modal(document.getElementById('saleModal'));
            const title = document.getElementById('saleModalTitle');
            const form = document.getElementById('saleForm');
            
            form.reset();
            document.getElementById('saleId').value = '';
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            
            // Reset sale items (category-wise rows)
            const saleItems = document.getElementById('saleItems');
            saleItems.innerHTML = `
                <div class="sale-item row mb-2">
                    <div class="col-md-3">
                        <select class="form-select sale-item-category" name="category"><option value="">Select Category</option></select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control" placeholder="Total Sale" name="total" min="0" step="0.01" required>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control" placeholder="Cost" name="cost" min="0" step="0.01">
                    </div>
                </div>
            `;

            // Load branches and populate category selects
            loadBranchesForSale();
            await loadCategoriesForSale();
            // populate existing category selects
            document.querySelectorAll('.sale-item-category').forEach(sel => {
                sel.innerHTML = document.getElementById('saleCategory').innerHTML;
            });

            // reset totals-only inputs
            document.getElementById('overallSaleTotal').value = '';
            document.getElementById('overallSaleCost').value = '';
            document.getElementById('overallSaleProfit').value = '';

            // sale mode toggling
            document.getElementById('saleModeCategory').addEventListener('change', function(){
                document.getElementById('saleItems').style.display = '';
                document.getElementById('saleTotalsOnly').style.display = 'none';
                document.getElementById('addSaleItemBtn').style.display = '';
            });
            document.getElementById('saleModeTotals').addEventListener('change', function(){
                document.getElementById('saleItems').style.display = 'none';
                document.getElementById('saleTotalsOnly').style.display = '';
                document.getElementById('addSaleItemBtn').style.display = 'none';
            });
            
            if (saleId) {
                title.textContent = 'Edit Sale';
                // TODO: Load sale data for editing
            } else {
                title.textContent = 'Add Sale';
            }
            
                modal.show();
        }
        
        async function loadBranchesForSale() {
            try {
                const branches = await api.getBranches();
                const select = document.getElementById('saleBranch');
                select.innerHTML = '<option value="">Select Branch</option>' +
                    branches.map(branch => `<option value="${branch._id}">${branch.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading branches for sale:', error);
            }
        }
        
        async function loadCategoriesForSale() {
            try {
                const categories = await api.getCategories();
                const select = document.getElementById('saleCategory');
                select.innerHTML = '<option value="">Select Category</option>' +
                    categories.map(category => `<option value="${category.name}">${category.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading categories for sale:', error);
            }
        }
        
        function addSaleItem() {
            const saleItems = document.getElementById('saleItems');
            const newItem = document.createElement('div');
            newItem.className = 'sale-item row mb-2';
            newItem.innerHTML = `
                <div class="col-md-4">
                    <select class="form-select sale-item-category" name="category">${document.getElementById('saleCategory').innerHTML}</select>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control" placeholder="Total Sale" name="total" min="0" step="0.01" required>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control" placeholder="Cost" name="cost" min="0" step="0.01">
                </div>
            `;
            saleItems.appendChild(newItem);
        }
        
        function calculateSaleTotals() {
            // If totals-only mode is selected, use the overall inputs
            const totalsOnly = document.getElementById('saleModeTotals') && document.getElementById('saleModeTotals').checked;
            let total = 0;
            let costTotal = 0;

            if (totalsOnly) {
                total = parseFloat(document.getElementById('overallSaleTotal').value) || 0;
                costTotal = parseFloat(document.getElementById('overallSaleCost').value) || 0;
            } else {
                const items = document.querySelectorAll('.sale-item');
                items.forEach(item => {
                    const totalSale = parseFloat(item.querySelector('[name="total"]').value) || 0;
                    const cost = parseFloat(item.querySelector('[name="cost"]').value) || 0;
                    total += totalSale;
                    costTotal += cost;
                });
            }

            const profit = total - costTotal;

            document.getElementById('saleTotal').textContent = formatCurrency(total);
            document.getElementById('saleCost').textContent = formatCurrency(costTotal);
            document.getElementById('saleProfit').textContent = formatCurrency(profit);

            // Also update totals-only profit field if visible
            const overallProfitEl = document.getElementById('overallSaleProfit');
            if (overallProfitEl) overallProfitEl.value = formatCurrency(profit);
        }
        
        async function saveSale() {
            const form = document.getElementById('saleForm');
            const saleId = document.getElementById('saleId').value;
            
            // Collect form data
            const date = document.getElementById('saleDate').value;
            const branchId = document.getElementById('saleBranch').value;
            const category = document.getElementById('saleCategory').value;
            
            if (!date || !branchId) {
                showNotification('Date and Branch are required', 'error');
                return;
            }
            
            // Collect items safely (support totals-only mode)
            const saleModeTotals = document.getElementById('saleModeTotals') && document.getElementById('saleModeTotals').checked;
            const items = [];

            if (saleModeTotals) {
                const overallTotal = parseFloat(document.getElementById('overallSaleTotal')?.value) || 0;
                const overallCost = parseFloat(document.getElementById('overallSaleCost')?.value) || 0;
                // push a single summary item so backend still gets an items array
                items.push({ name: 'Totals', category: '', unitPrice: 0, total: overallTotal, cost: overallCost });
            } else {
                const itemElements = document.querySelectorAll('.sale-item');
                for (const item of itemElements) {
                    const nameEl = item.querySelector('[name="name"]');
                    const name = nameEl ? nameEl.value : '';
                    const unitPrice = parseFloat(item.querySelector('[name="unitPrice"]')?.value) || 0;
                    const cost = parseFloat(item.querySelector('[name="cost"]')?.value) || 0;
                    const totalSale = parseFloat(item.querySelector('[name="total"]')?.value) || 0;
                    const itemCategory = item.querySelector('[name="category"]')?.value || '';

                    // accept rows that have a total (name optional)
                    if (!isNaN(totalSale) && totalSale > 0) {
                        items.push({ name, category: itemCategory, unitPrice, total: totalSale, cost });
                    }
                }
            }

            if (items.length === 0) {
                showNotification('At least one item or totals entry is required', 'error');
                return;
            }

            // Calculate totals
            let total = 0;
            let costTotal = 0;
            if (saleModeTotals) {
                total = Number(items[0].total || 0);
                costTotal = Number(items[0].cost || 0);
            } else {
                total = items.reduce((sum, it) => sum + Number(it.total || 0), 0);
                costTotal = items.reduce((sum, it) => sum + Number(it.cost || 0), 0);
            }
            const profit = total - costTotal;
            
            const saleData = {
                branchId: branchId,
                date: new Date(date),
                items: items,
                total: total,
                costTotal: costTotal,
                profit: profit,
                category: category || ''
            };
            
            const saveBtn = document.getElementById('saleSaveText');
            const originalText = saveBtn.textContent;
            saveBtn.innerHTML = '<div class="loading-spinner me-2"></div>Saving...';
            
            try {
                let savedSale;
                if (saleId) {
                    // Update existing sale
                    savedSale = await api.updateSale(saleId, saleData);
                    const idx = appData.sales.findIndex(s => s._id === saleId);
                    if (idx !== -1) appData.sales[idx] = savedSale;
                } else {
                    // Create new sale
                    savedSale = await api.createSale(saleData);
                    appData.sales.unshift(savedSale);
                }
                
                updateSalesTable();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    updateDashboardCards();
                    updateRecentSalesTable();
                }
                
                bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide();
                showNotification('Sale saved successfully!', 'success');
                } catch (error) {
                console.error('Error saving sale:', error);
                showNotification('Failed to save sale', 'error');
            } finally {
                saveBtn.textContent = originalText;
            }
        }
        
        async function deleteSale(saleId) {
            if (!confirm('Are you sure you want to delete this sale?')) {
                return;
            }
            
            try {
                // require admin password for deleting a sale
                const pwd = prompt('Enter admin password to delete this sale:');
                if (!pwd) {
                    showNotification('Admin password required to delete sale', 'error');
                    return;
                }
                await api.adminDelete('sales', saleId, pwd);
                appData.sales = appData.sales.filter(s => s._id !== saleId);
                updateSalesTable();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    updateDashboardCards();
                    updateRecentSalesTable();
                }
                showNotification('Sale deleted successfully!', 'success');
			} catch (error) {
                console.error('Error deleting sale:', error);
                showNotification('Failed to delete sale', 'error');
            }
        }
        
        // Branches functions
        async function loadBranches() {
            try {
                console.log('ðŸ”„ Loading branches from API...');
                const branches = await api.getBranches();
                console.log('âœ… Branches loaded from API:', branches);
                appData.branches = branches;
                updateBranchesTable();
            } catch (error) {
                console.error('âŒ Error loading branches:', error);
                showNotification('Failed to load branches', 'error');
            }
        }
        
        function updateBranchesTable() {
            console.log('ðŸ”„ Updating branches table...');
            const tbody = document.getElementById('branchesTable');
            console.log('ðŸ“Š Branches data:', appData.branches);
            
            if (appData.branches.length === 0) {
                console.log('âš ï¸ No branches found, showing empty message');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No branches available</td></tr>';
                return;
            }
            
            console.log(`âœ… Rendering ${appData.branches.length} branches`);
            const html = appData.branches.map(branch => `
                <tr>
                    <td>${branch.name}</td>
                    <td>${branch.address || 'N/A'}</td>
                    <td>${branch.phone || 'N/A'}</td>
                    <td>${branch.email || 'N/A'}</td>
                    <td>${formatDate(branch.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editBranch('${branch._id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBranch('${branch._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            console.log('âœ… Table HTML updated successfully');
        }
        
        function openBranchModal(branchId = null) {
            const modal = new bootstrap.Modal(document.getElementById('branchModal'));
            const title = document.getElementById('branchModalTitle');
            const form = document.getElementById('branchForm');
            
            form.reset();
            document.getElementById('branchId').value = '';
            
            if (branchId) {
                const branch = appData.branches.find(b => b._id === branchId);
                if (branch) {
                    title.textContent = 'Edit Branch';
                    document.getElementById('branchId').value = branch._id;
                    document.getElementById('branchName').value = branch.name;
                    document.getElementById('branchAddress').value = branch.address || '';
                    document.getElementById('branchPhone').value = branch.phone || '';
                    document.getElementById('branchEmail').value = branch.email || '';
                }
            } else {
                title.textContent = 'Add Branch';
            }
            
            modal.show();
        }
        
        async function saveBranch() {
            const form = document.getElementById('branchForm');
            const branchId = document.getElementById('branchId').value;
            
            const branchData = {
                name: document.getElementById('branchName').value,
                address: document.getElementById('branchAddress').value,
                phone: document.getElementById('branchPhone').value,
                email: document.getElementById('branchEmail').value
            };
            
            if (!branchData.name.trim()) {
                showNotification('Branch name is required', 'error');
				return;
			}
			
            const saveBtn = document.getElementById('branchSaveText');
            const originalText = saveBtn.textContent;
            saveBtn.innerHTML = '<div class="loading-spinner me-2"></div>Saving...';
            
            try {
                let savedBranch;
                if (branchId) {
                    // require admin password for updates
                    const pwd = prompt('Enter admin password to update this branch:');
                    if (!pwd) {
                        showNotification('Admin password required to update branch', 'error');
                        return;
                    }
                    savedBranch = await api.adminUpdate('branches', branchId, branchData, pwd);
                    const index = appData.branches.findIndex(b => b._id === branchId);
                    if (index !== -1) {
                        appData.branches[index] = savedBranch;
                    }
                } else {
                    savedBranch = await api.createBranch(branchData);
                    appData.branches.push(savedBranch);
                }
                
                updateBranchesTable();
                bootstrap.Modal.getInstance(document.getElementById('branchModal')).hide();
                showNotification('Branch saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving branch:', error);
                showNotification('Failed to save branch', 'error');
            } finally {
                saveBtn.textContent = originalText;
            }
        }
        
        async function editBranch(branchId) {
            openBranchModal(branchId);
        }
        
        async function deleteBranch(branchId) {
            if (!confirm('Are you sure you want to delete this branch?')) {
                return;
            }
            const pwd = prompt('Enter admin password to delete this branch:');
            if (!pwd) {
                showNotification('Admin password required to delete branch', 'error');
                return;
            }
            try {
                await api.adminDelete('branches', branchId, pwd);
                appData.branches = appData.branches.filter(b => b._id !== branchId);
                updateBranchesTable();
                showNotification('Branch deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting branch:', error);
                showNotification('Failed to delete branch', 'error');
            }
        }
        
        // Settings functions
        async function loadSettings() {
            try {
                const settings = await api.getSettings();
                appData.settings = settings;
                updateSettingsForm();
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('Failed to load settings', 'error');
            }
        }
        
        function updateSettingsForm() {
            const settings = appData.settings;
            document.getElementById('companyName').value = settings.companyName || '';
            document.getElementById('currency').value = settings.currency || 'PKR';
            document.getElementById('dateFormat').value = settings.dateFormat || 'DD/MM/YYYY';
            document.getElementById('itemsPerPage').value = settings.itemsPerPage || 10;
            document.getElementById('defaultCostPercent').value = settings.defaultCostPercent || 70;
        }
        
        // Settings form submission
        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const settingsData = {
                companyName: formData.get('companyName'),
                currency: formData.get('currency'),
                dateFormat: formData.get('dateFormat'),
                itemsPerPage: parseInt(formData.get('itemsPerPage')),
                defaultCostPercent: parseFloat(formData.get('defaultCostPercent'))
            };
            
            try {
                const savedSettings = await api.updateSettings(settingsData);
                appData.settings = savedSettings;
                showNotification('Settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Failed to save settings', 'error');
            }
        });
        
        // Add event listeners for sale item calculations
        document.addEventListener('input', function(e) {
            if (e.target.matches('#saleItems input[type="number"]') || e.target.matches('#overallSaleTotal') || e.target.matches('#overallSaleCost')) {
                calculateSaleTotals();
            }
        });
        
        // Test API connection
        async function testApiConnection() {
            try {
                console.log('ðŸ§ª Testing API connection...');
                const health = await api.getHealth();
                console.log('âœ… API Health:', health);
                
                const branches = await api.getBranches();
                console.log('âœ… API Branches:', branches);
                console.log('ðŸ“Š Number of branches:', branches.length);
                console.log('ðŸ“‹ First branch:', branches[0]);
                
                showNotification(`API working! Found ${branches.length} branches`, 'success');
                
                // Test table update directly
                console.log('ðŸ§ª Testing table update...');
                appData.branches = branches;
                updateBranchesTable();
                
            } catch (error) {
                console.error('âŒ API Test Failed:', error);
                showNotification('API connection failed', 'error');
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar link clicks (delegation)
            document.getElementById('leftSidebar').addEventListener('click', function(e) {
                const link = e.target.closest('.nav-link');
                if (!link) return;
                e.preventDefault();
                const section = link.getAttribute('data-section');
                if (section) showSection(section, { currentTarget: link });
            });

            // Sidebar toggle for small screens
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                const sb = document.getElementById('leftSidebar');
                if (sb.style.display === 'none' || getComputedStyle(sb).display === 'none') {
                    sb.style.display = 'block';
                    document.querySelector('.main-content').style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width') || '250px';
                } else {
                    sb.style.display = 'none';
                    document.querySelector('.main-content').style.marginLeft = '0';
                }
            });

            console.log('ðŸš€ D.Watson Pharmacy Frontend Initialized');
            console.log('ðŸ“¡ API Service Ready');
            console.log('ðŸ—„ï¸ No localStorage - All data from MongoDB via API');
            
            // Test API connection first
            testApiConnection();

            // Dashboard-specific initialization
            setDefaultDashboardDates();
            populateDashboardBranchSelector();
            document.getElementById('applyDashboardFilter').addEventListener('click', function() {
                renderCategoryBreakdown();
            });

            // Initial render
            renderCategoryBreakdown();

            // Reports initialization
            // set default report dates (same as dashboard)
            const repTo = document.getElementById('reportTo');
            const repFrom = document.getElementById('reportFrom');
            if (repTo && repFrom) {
                const to = new Date();
                const from = new Date();
                from.setDate(to.getDate() - 30);
                repTo.value = to.toISOString().slice(0,10);
                repFrom.value = from.toISOString().slice(0,10);
            }
            populateReportBranchSelector();

            // Load initial dashboard data
            loadDashboardData();
        });
	</script>
</body>
</html>
